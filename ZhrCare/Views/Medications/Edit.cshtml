@model ZhrCare.Models.Medication

@{
    ViewData["Title"] = "Edit Medication";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow border-0" style="border-radius: 15px;">
                <div class="card-header text-white text-center" style="background-color: #6c5ce7; border-radius: 15px 15px 0 0;">
                    <h4 class="mb-0">üìù Edit Medication Details</h4>
                </div>

                <div class="card-body p-4">
                    <form asp-action="Edit">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        <input type="hidden" asp-for="Id" />
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="PatientId" class="form-label fw-bold">Patient</label>
                                    <select asp-for="PatientId" class="form-select" asp-items="ViewBag.PatientId"></select>
                                    <span asp-validation-for="PatientId" class="text-danger"></span>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label asp-for="Name" class="form-label fw-bold">Medication Name</label>
                                    <input asp-for="Name" class="form-control" />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="FrequencyType" class="form-label fw-bold">Frequency</label>
                                    <select asp-for="FrequencyType" id="FrequencyType" class="form-select">
                                        <option value="Daily">Daily</option>
                                        <option value="Weekly">Weekly</option>
                                        <option value="Monthly">Monthly</option>
                                    </select>
                                    <span asp-validation-for="FrequencyType" class="text-danger"></span>
                                </div>

                                <div class="form-group mb-3" id="weeklyDaysSection" style="@(Model.FrequencyType == "Weekly" ? "" : "display:none;")">
                                    <label class="form-label fw-bold d-block mb-2">Selected Days</label>
                                    <div class="d-flex flex-wrap gap-2 p-2 border rounded bg-light">
                                        @{
                                            var allDays = new[] { "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday" };
                                            var savedDays = Model.SelectedDays?.Split(", ").ToList() ?? new List<string>();
                                            foreach (var day in allDays)
                                            {
                                                <div class="form-check">
                                                    <input class="form-check-input day-checkbox" type="checkbox" value="@day" id="day_@day" 
                                                           @(savedDays.Contains(day) ? "checked" : "")>
                                                    <label class="form-check-label small" for="day_@day">@day</label>
                                                </div>
                                            }
                                        }
                                    </div>
                                    <input type="hidden" asp-for="SelectedDays" id="SelectedDaysHidden" value="@Model.SelectedDays" />
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="ScheduledTime" class="form-label fw-bold">Dose Time</label>
                                    <input asp-for="ScheduledTime" type="time" class="form-control" />
                                    <span asp-validation-for="ScheduledTime" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Dosage" class="form-label fw-bold">Dosage</label>
                                    <input asp-for="Dosage" class="form-control" />
                                    <span asp-validation-for="Dosage" class="text-danger"></span>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label asp-for="StartDate" class="form-label fw-bold">Start Date</label>
                                    <input asp-for="StartDate" type="date" class="form-control" />
                                    <span asp-validation-for="StartDate" class="text-danger"></span>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label asp-for="EndDate" class="form-label fw-bold">End Date</label>
                                    <input asp-for="EndDate" type="date" class="form-control" />
                                    <span asp-validation-for="EndDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn text-white btn-lg" style="background-color: #6c5ce7;">Update Medication</button>
                            <a asp-action="Index" class="btn btn-outline-secondary">Cancel and Return</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function () {
            function updateSelectedDays() {
                var selectedDays = [];
                $('.day-checkbox:checked').each(function () {
                    selectedDays.push($(this).val());
                });
                $('#SelectedDaysHidden').val(selectedDays.join(', '));
            }

            $('.day-checkbox').on('change', function () {
                updateSelectedDays();
            });

            $('#FrequencyType').on('change', function () {
                if ($(this).val() === 'Weekly') {
                    $('#weeklyDaysSection').slideDown();
                } else {
                    $('#weeklyDaysSection').slideUp();
                    $('.day-checkbox').prop('checked', false); 
                    updateSelectedDays();
                }
            });
        });
    </script>
}